import Foundation
import Interfaces
import plate

func build(targetDirectory: String, buildType: BuildType) async throws {
    let args = buildType == .debug ? ["build", "-c", "debug"] : ["build", "-c", "release"]
    print("Building project...")
    guard await runShellCommand("swift", args, in: targetDirectory) else {
        throw NSError(domain: "sbm.build", code: 1, userInfo: [NSLocalizedDescriptionKey: "Build failed"])
    }
}

func buildOnly(targetDirectory: String, buildType: BuildType) async throws {
    try await build(targetDirectory: targetDirectory, buildType: buildType)
    print("\nBuild complete. Binary kept in project directory, not moved to sbm-bin.".ansi(.green))
}

func buildAndDeploySelected(
    targetDirectory: String,
    buildType: BuildType,
    defaultDestination: String,
    targets: [String],
    perTargetDestination: [String:String] = [:]
) async throws {
    try await build(targetDirectory: targetDirectory, buildType: buildType)

    print("\nMoving selected binaries to " + "sbm-bin".ansi(.italic) + "...")
    let projectFolderName = URL(fileURLWithPath: targetDirectory).lastPathComponent
    let buildPrefix = (buildType == .debug ? ".build/debug/" : ".build/release/")

    guard !targets.isEmpty else {
        throw NSError(domain: "sbm.deploy", code: 2, userInfo: [NSLocalizedDescriptionKey: "No selected executables to deploy"])
    }

    for targetName in targets {
        print("")
        let sourceURL = URL(fileURLWithPath: targetDirectory).appendingPathComponent(buildPrefix + targetName)
        let destinationRoot = perTargetDestination[targetName] ?? defaultDestination
        let destinationURL = URL(fileURLWithPath: destinationRoot).appendingPathComponent(targetName)

        var binaryExists = false
        var binaryPlaced = false
        do {
            if FileManager.default.fileExists(atPath: destinationURL.path) {
                binaryExists = true
                print("\(destinationURL.path)".ansi(.brightBlack, .bold) + " already exists. Replacing it...".ansi(.brightBlack))
            }
            if let replacedURL = try FileManager.default.replaceItemAt(destinationURL, withItemAt: sourceURL) {
                print("Binary ".ansi(.brightBlack) + (binaryExists ? "re".ansi(.brightBlack) : "") +
                      "placed at ".ansi(.brightBlack) + "\(replacedURL.path)".ansi(.bold, .brightBlack))
                binaryPlaced = true
            } else {
                print("Binary replaced, but no new URL was returned.".ansi(.brightBlack))
            }
        } catch {
            throw NSError(domain: "sbm.deploy", code: 3, userInfo: [NSLocalizedDescriptionKey: "Failed to replace binary: \(error)"])
        }

        // metadata
        let metadataPath = destinationURL.deletingLastPathComponent().appendingPathComponent("\(targetName).metadata")
        let metadataContent =
        """
        ProjectRootPath=\(targetDirectory)
        BuildType=\(buildType.directoryString())
        DeployedAt=\(ISO8601DateFormatter().string(from: Date()))
        DestinationRoot=\(destinationRoot)
        """
        do {
            try metadataContent.write(to: metadataPath, atomically: true, encoding: .utf8)
            print("Metadata file created at ".ansi(.brightBlack) + "\(metadataPath.path)".ansi(.brightBlack, .bold))
        } catch {
            print("Warning: Failed to write metadata file: \(error)".ansi(.yellow))
        }

        print("")
        let successOut = "\(targetName) ".ansi(.bold) + "is now an executable binary for " + "\(projectFolderName)".ansi(.italic)
        let successOutSpaced = "\n        \(successOut)\n    "
        let errorOut = "Failed to move \(targetName) binary to sbm-bin, retrace steps.".ansi(.red)
        print(binaryPlaced ? successOutSpaced : errorOut)
    }
}

func cleanBuild(for targetDirectory: String) async throws {
    let args = ["package", "clean"]
    print("Cleaning build artifacts in project directory: \(targetDirectory)".ansi(.brightBlack))
    guard await runShellCommand("swift", args, in: targetDirectory) else {
        throw NSError(domain: "sbm.clean", code: 1, userInfo: [NSLocalizedDescriptionKey: "Failed to clean build artifacts"])
    }
    print("\nClean successful!".ansi(.green))
}
