import Foundation
import plate
import Interfaces

enum ExecutableRole: String {
    case cli, app, other
}

struct ExecutableTarget: Sendable {
    let name: String
    let path: String?
    let role: ExecutableRole
}

private func guessRole(name: String, path: String?) -> ExecutableRole {
    let s = (name + " " + (path ?? "")).lowercased()
    if s.contains("cli") || s.contains("tool") || s.contains("cmd") { return .cli }
    if s.contains("app") || s.contains("application") { return .app }
    return .other
}

func getExecutableTargetsDetailed(from directory: String) async -> [ExecutableTarget]? {
    do {
        let data = try await dumpPackageData(for: directory)
        let blob = SwiftPackageDumpBlob(raw: data)
        let reader = try SwiftPackageDumpReader(blob: blob)

        if let pkg = reader.packageName() {
            print("Package: \(pkg)".ansi(.brightBlack))
        }

        let rawTargets = reader.allTargets()
        var out: [ExecutableTarget] = []
        for t in rawTargets {
            guard (try? t["type"]?.stringValue) == "executable" else { continue }
            guard let name = try? t["name"]?.stringValue else { continue }
            let path = try? t["path"]?.stringValue
            out.append(.init(name: name, path: path, role: guessRole(name: name, path: path)))
        }
        if out.isEmpty {
            print("Error: No executable targets found in dump-package output.".ansi(.red))
            return nil
        }
        return out
    } catch {
        print("Error reading dump-package JSON: \(error.localizedDescription)".ansi(.red))
        return nil
    }
}
